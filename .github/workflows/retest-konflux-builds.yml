# There are two kind of comments in the GitHub pull request: conversation comments and pull request review comments.
# Konflux monitors `/retest` conversation comments for rerunning pipelines.
# The conversation comments belong to `/issues/` Github API.

name: Retest Failed Konflux Builds

on:
  workflow_call:
    inputs:
      max_retries:
        description: 'Maximum number of retries for failed builds'
        required: false
        type: number
        default: 3
      check_name_suffix:
        description: 'Suffix to filter Konflux build check names (e.g., -on-push)'
        required: false
        type: string
        default: '-on-push'

jobs:
  cleanup-retest-comments:
    if: |
      github.event_name == 'pull_request' &&
      !contains(github.event.pull_request.labels.*.name, 'disable-konflux-auto-retest')
    runs-on: ubuntu-latest

    permissions:
      pull-requests: write
      # We need `issues: write` permission to delete conversation comments.
      # See top of the file comment for `issues` explanation.
      issues: write

    steps:
      - name: Remove existing /retest comments as new commits were pushed
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"

          echo "New commit pushed to PR #$PR_NUMBER. Cleaning up existing /retest comments from GitHub Actions..."

          # Get all comments from github-actions bot containing /retest and ending with CHECK_NAME_SUFFIX
          COMMENT_IDS=$(gh api --paginate "repos/${{ github.repository }}/issues/$PR_NUMBER/comments" \
            --jq '.[] | select(.user.login == "github-actions[bot]" and (.body | contains("/retest") and endswith("${{ inputs.check_name_suffix }}"))) | .id')

          if [ -z "$COMMENT_IDS" ]; then
            echo "No /retest comments found to clean up"
          else
            # Delete each comment
            for COMMENT_ID in $COMMENT_IDS; do
              echo "Deleting comment $COMMENT_ID"
              gh api -X DELETE "repos/${{ github.repository }}/issues/comments/$COMMENT_ID"
            done
            echo "Cleanup complete"
          fi

  auto-retest-failed-konflux-build:
    if: |
      github.event_name == 'check_run' &&
      github.event.check_run.pull_requests[0] != null &&
      github.event.check_run.conclusion == 'failure' &&
      startsWith(github.event.check_run.name, 'Red Hat Konflux') &&
      !contains(github.event.check_run.pull_requests[0].labels.*.name, 'disable-konflux-auto-retest')
    runs-on: ubuntu-latest

    permissions:
      pull-requests: write
      # We need `issues: write` permission to write conversation comments.
      # See top of the file comment for `issues` and conversation comments explanation.
      issues: write

    steps:
      - name: Auto-retest failed Konflux builds
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MAX_RETRIES: ${{ inputs.max_retries }}
          CHECK_NAME_SUFFIX: ${{ inputs.check_name_suffix }}
        run: |
          CHECK_NAME="${{ github.event.check_run.name }}"

          # Check if the check name ends with the configured suffix
          if [[ ! "$CHECK_NAME" == *"$CHECK_NAME_SUFFIX" ]]; then
            echo "Skipping $CHECK_NAME (does not end with $CHECK_NAME_SUFFIX)"
            exit 0
          fi

          # Remove the "Red Hat Konflux /" prefix to get the base check name
          CHECK_NAME="${CHECK_NAME#Red Hat Konflux / }"
          PR_NUMBER="${{ github.event.check_run.pull_requests[0].number }}"

          # Count comments containing the retest command (fetches all comments via pagination)
          RETRY_COUNT="$(gh api --paginate "repos/${{ github.repository }}/issues/$PR_NUMBER/comments" \
            --jq '[.[] | select(.body | contains("/retest '"$CHECK_NAME"'"))] | length')"

          if [ "$RETRY_COUNT" -ge "$MAX_RETRIES" ]; then
            echo "::warning::Maximum retry limit ($MAX_RETRIES) reached for $CHECK_NAME on PR #$PR_NUMBER"
          else
            echo "Retrying $CHECK_NAME (attempt $((RETRY_COUNT + 1))/$MAX_RETRIES)"
            gh pr comment "$PR_NUMBER" --repo ${{ github.repository }} --body "/retest $CHECK_NAME"
          fi
