name: Retag and push images
description: |
  This action will, as stated in its name, retag and push images

inputs:
  src-image:
    description: |
      The image that will be retagged
    required: true
  dst-image:
    description: |
      A target image that will be generated by retagging src-image and later
      pushed
    required: true
  username:
    description: |
      Username used to login to the repository the push is aimed at
    required: false
  password:
    description: |
      Password used to login to the repository the push is aimed at
    required: false

runs:
  using: "composite"
  steps:
    - name: Get registry name
      id: get-registry-name
      shell: bash
      run: |
        dst_image=${{ inputs.dst-image }}
        registry="${dst_image%%/*}"
        echo "registry=$registry" >> $GITHUB_OUTPUT

    - uses: docker/login-action@v2
      if: inputs.password != '' && inputs.username != ''
      with:
        registry: ${{ steps.get-registry-name.outputs.registry }}
        username: ${{ inputs.username }}
        password: ${{ inputs.password }}

    - shell: bash
      run: |
        set -uo pipefail
        "${{ github.action_path }}/../../common/common.sh" \
          "${{ github.action_path }}/retag-and-push.sh" \
          "${{ inputs.src-image }}" \
          "${{ inputs.dst-image }}"
